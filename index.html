<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Home</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
:root{
  --bg:#f8fafc;
  --card:#ffffff;
  --panel:#e0f2fe;
  --text:#0f172a;
  --btn:#93c5fd;
  --btnText:#020617;
  --top1:#60a5fa;
  --top2:#38bdf8;
  --success:#22c55e;
  --danger:#ef4444;
}
.dark{
  --bg:#020617;
  --card:#0f172a;
  --panel:#1e293b;
  --text:#e5e7eb;
  --btn:#334155;
  --btnText:#e5e7eb;
  --top1:#1e293b;
  --top2:#020617;
}
*{box-sizing:border-box;font-family:system-ui}
body{margin:0;background:var(--bg);color:var(--text);transition:.3s}

/* LOGIN */
.login{
  height:100vh;display:flex;align-items:center;justify-content:center;
  background:linear-gradient(135deg,#60a5fa,#38bdf8)
}
.login-box{
  background:var(--card);padding:40px;border-radius:20px;
  width:90%;max-width:380px;text-align:center
}
.login-box input{
  width:100%;padding:14px;margin:10px 0;
  border-radius:10px;border:1px solid #cbd5f5
}
.login-box button{
  width:100%;padding:14px;border:none;
  border-radius:12px;background:#60a5fa;color:white;font-size:18px
}

/* SIDEBAR */
.sidebar{
  position:fixed;top:0;left:0;height:100%;width:240px;
  background:var(--panel);padding:20px;
  transform:translateX(-100%);transition:.3s;z-index:20
}
.sidebar.show{transform:translateX(0)}
.sidebar button{
  width:100%;padding:12px;margin:8px 0;border:none;
  border-radius:12px;background:var(--btn);
  color:var(--btnText);font-size:16px
}
.toggle{
  margin-top:20px;padding:12px;border-radius:12px;
  background:var(--btn);display:flex;justify-content:space-between
}

#overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.4);
  opacity:0;pointer-events:none;transition:.3s;z-index:15
}
#overlay.show{opacity:1;pointer-events:auto}

.hidden{display:none}

/* TOPBAR */
.topbar{
  display:flex;align-items:center;gap:10px;
  padding:14px 16px;
  background:linear-gradient(135deg,var(--top1),var(--top2));
  color:white
}
.menu{font-size:26px;cursor:pointer}
.topbar h3{flex:1;text-align:center;margin:0}

/* PAGE */
.page{display:none;padding:20px}
.page.active{display:block}

/* CARDS */
.card{
  background:var(--card);padding:22px;
  border-radius:20px;margin-bottom:20px
}
.hello-card{background:linear-gradient(135deg,#f0f9ff,#e0f2fe)}
.dark .hello-card{background:#0f172a}
.esp-card{
  display:flex;align-items:center;gap:14px;
  background:linear-gradient(135deg,#ecfeff,#e0f2fe)
}
.dark .esp-card{background:#1e293b}
.online{color:var(--success)}
.offline{color:var(--danger)}

.led-vertical{display:flex;flex-direction:column;gap:14px}
.led-btn{
  padding:18px;border:none;border-radius:18px;
  font-size:17px;font-weight:700;
  background:var(--btn);color:var(--btnText)
}
</style>
</head>

<body>

<!-- LOGIN -->
<div class="login" id="login">
  <div class="login-box">
    <h2>Smart Home</h2>
    <input id="name" placeholder="Your Name">
    <input id="phone" placeholder="10 Digit Phone" maxlength="10">
    <button id="loginBtn">Login</button>
    <p id="msg"></p>
  </div>
</div>

<!-- SIDEBAR -->
<div class="sidebar" id="sidebar">
  <button onclick="navigate('home')">Home</button>
  <button onclick="navigate('room1')">Room 1</button>
  <button onclick="logout()">Logout</button>
  <div class="toggle">
    <span>üåô Dark</span>
    <input type="checkbox" id="darkToggle">
  </div>
</div>
<div id="overlay"></div>

<!-- APP -->
<div class="hidden" id="app">
  <div class="topbar">
    <span class="menu" onclick="toggleSidebar()">‚ò∞</span>
    <h3>Home</h3>
  </div>

  <div class="page active" id="home">
    <div class="card hello-card">
      <h2 id="hello"></h2>
      <p>Welcome to Smart Home</p>
    </div>
    <div class="card esp-card">
      <div id="espStatus">Checking ESP32‚Ä¶</div>
    </div>
  </div>

  <div class="page" id="room1">
    <div class="card" id="temp">Temperature: -- ¬∞C</div>
    <div class="card">
      <div class="led-vertical" id="ledGrid"></div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import {
  getDatabase, ref, set, get, onValue, runTransaction
} from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

/* DOM */
const login=document.getElementById("login");
const app=document.getElementById("app");
const loginBtn=document.getElementById("loginBtn");
const nameI=document.getElementById("name");
const phoneI=document.getElementById("phone");
const msg=document.getElementById("msg");
const hello=document.getElementById("hello");
const sidebar=document.getElementById("sidebar");
const overlay=document.getElementById("overlay");
const espStatus=document.getElementById("espStatus");
const temp=document.getElementById("temp");
const ledGrid=document.getElementById("ledGrid");
const darkToggle=document.getElementById("darkToggle");

/* FIREBASE */
const fb=initializeApp({
  apiKey:"AIzaSyAht7TWN8NlbICl0VbEIuc19Mri7oPlXvc",
  databaseURL:"https://home-automation-89830-default-rtdb.firebaseio.com"
});
const db=getDatabase(fb);

/* DARK MODE */
if(localStorage.theme==="dark"){
  document.body.classList.add("dark");
  darkToggle.checked=true;
}
darkToggle.onchange=()=>{
  document.body.classList.toggle("dark");
  localStorage.theme=document.body.classList.contains("dark")?"dark":"light";
};

/* LOGIN + VISIT COUNT (FIXED) */
loginBtn.onclick=()=>{
  const name=nameI.value.trim();
  const phone=phoneI.value.trim();
  if(name===""||phone.length!==10){
    msg.innerText="Invalid details";
    return;
  }

  const vRef = ref(db,"visitors/"+phone);

  runTransaction(vRef, (data)=>{
    if(data===null){
      return {
        name,
        phone,
        visits:1,
        lastVisit:new Date().toLocaleString()
      };
    }else{
      data.visits = (data.visits||0)+1;
      data.lastVisit = new Date().toLocaleString();
      return data;
    }
  });

  openApp(name);
};

function openApp(name){
  login.classList.add("hidden");
  app.classList.remove("hidden");
  hello.innerText="Hello, "+name+" üëã";
  startESP();
}

/* SIDEBAR */
window.toggleSidebar=()=>{
  sidebar.classList.toggle("show");
  overlay.classList.toggle("show");
};
overlay.onclick=()=>toggleSidebar();

window.navigate=p=>{
  document.querySelectorAll(".page").forEach(pg=>pg.classList.remove("active"));
  document.getElementById(p).classList.add("active");
  sidebar.classList.remove("show");
  overlay.classList.remove("show");
};

window.logout=()=>location.reload();

/* ESP32 */
function startESP(){
  setInterval(()=>{
    get(ref(db,"/status/lastSeen")).then(s=>{
      const ok=s.exists()&&Date.now()-s.val()<10000;
      espStatus.innerHTML=ok
        ? "<span class='online'>‚óè ESP32 ONLINE</span>"
        : "<span class='offline'>‚óè ESP32 OFFLINE</span>";
    });
  },5000);
}

/* TEMP */
onValue(ref(db,"/status/temperature"),s=>{
  if(s.exists()) temp.innerText="Temperature: "+s.val()+" ¬∞C";
});

/* LEDS */
const states=[0,0,0,0];
for(let i=1;i<=4;i++){
  const b=document.createElement("button");
  b.className="led-btn";
  b.onclick=()=>set(ref(db,"/leds/led"+i),!states[i-1]);
  ledGrid.appendChild(b);
  onValue(ref(db,"/leds/led"+i),s=>{
    states[i-1]=s.val();
    b.innerText=states[i-1]?"Turn OFF LED "+i:"Turn ON LED "+i;
  });
}
</script>

// Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyCPvcix5rBSqLL80WzJ-yedxIf5tD4q8P0",
  authDomain: "smart-home-automation-caf6a.firebaseapp.com",
  projectId: "smart-home-automation-caf6a",
  storageBucket: "smart-home-automation-caf6a.firebasestorage.app",
  messagingSenderId: "1015259898808",
  appId: "1:1015259898808:web:454393919d0ce4641da54d",
  measurementId: "G-R7L0L9S5GE"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
</body>
</html>

